<!doctype html>
<html lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>ASCII Punctuation Fixer</title>
  <style>
    :root{
      --bg: #0b0f17;
      --panel: rgba(255,255,255,.06);
      --panel-2: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --border: rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --accent: #7aa2ff;
      --accent-2: #9bffd0;
      --danger: #ff6b6b;
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg: #f7f8fb;
        --panel: rgba(0,0,0,.04);
        --panel-2: rgba(0,0,0,.06);
        --text: rgba(0,0,0,.88);
        --muted: rgba(0,0,0,.62);
        --border: rgba(0,0,0,.10);
        --shadow: 0 10px 30px rgba(0,0,0,.10);
        --accent: #2f6bff;
        --accent-2: #16a34a;
        --danger: #dc2626;
      }
    }

    *{ box-sizing: border-box; }
    body{
      margin: 0;
      font-family: var(--sans);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(122,162,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 80% 20%, rgba(155,255,208,.16), transparent 55%),
                  var(--bg);
      color: var(--text);
    }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 28px 18px 60px;
    }

    header{
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: flex-end;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .title{
      display: grid;
      gap: 6px;
    }
    h1{
      font-size: 18px;
      letter-spacing: .2px;
      margin: 0;
      font-weight: 700;
    }
    .subtitle{
      margin: 0;
      color: var(--muted);
      font-size: 14px;
      max-width: 70ch;
      line-height: 1.35;
    }

    .topbar{
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: 999px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .chip label{
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--muted);
      font-size: 13px;
      user-select: none;
      cursor: pointer;
      white-space: nowrap;
    }
    .chip input{ transform: translateY(1px); }

    .stats{
      display: inline-flex;
      gap: 10px;
      align-items: center;
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }
    .dot{ width: 6px; height: 6px; border-radius: 99px; background: var(--border); display: inline-block; }

    .grid{
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 14px;
    }
    @media (min-width: 980px){
      .grid{ grid-template-columns: 1fr 1fr; }
    }

    .card{
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }

    .cardhead{
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: baseline;
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(to bottom, var(--panel-2), transparent);
    }

    .cardhead strong{ font-size: 13px; letter-spacing: .2px; }
    .hint{ font-size: 12px; color: var(--muted); }

    textarea{
      width: 100%;
      min-height: 320px;
      padding: 14px;
      border: 0;
      outline: 0;
      resize: vertical;
      background: transparent;
      color: var(--text);
      font-family: var(--mono);
      font-size: 13.5px;
      line-height: 1.45;
    }

    .actions{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      margin: 14px 0 0;
    }

    .btnrow{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    button{
      appearance: none;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 650;
      letter-spacing: .1px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    button:hover{ filter: brightness(1.06); }
    button:active{ transform: translateY(1px); }
    button.primary{
      border-color: rgba(122,162,255,.35);
      background: linear-gradient(180deg, rgba(122,162,255,.22), rgba(122,162,255,.10));
    }
    button.danger{
      border-color: rgba(255,107,107,.35);
      background: linear-gradient(180deg, rgba(255,107,107,.18), rgba(255,107,107,.08));
    }
    .k{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      border: 1px solid var(--border);
      padding: 2px 6px;
      border-radius: 8px;
    }

    details{
      margin-top: 14px;
      border: 1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      backdrop-filter: blur(10px);
    }
    summary{
      padding: 14px;
      cursor: pointer;
      user-select: none;
      font-weight: 700;
      font-size: 13px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(to bottom, var(--panel-2), transparent);
    }
    .diag{
      padding: 12px 14px 14px;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      font-family: var(--mono);
      font-size: 12.5px;
      overflow: hidden;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    thead th{
      text-align: left;
      padding: 10px 10px;
      color: var(--muted);
      background: rgba(0,0,0,.08);
      border-bottom: 1px solid var(--border);
    }
    @media (prefers-color-scheme: light){
      thead th{ background: rgba(0,0,0,.04); }
    }
    tbody td{
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }
    tbody tr:last-child td{ border-bottom: 0; }
    .mono{ font-family: var(--mono); }
    .muted{ color: var(--muted); }
    .pill{
      display: inline-block;
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      background: rgba(0,0,0,.05);
      white-space: nowrap;
    }
    .charbox{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      height: 22px;
      padding: 0 6px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.05);
      color: var(--text);
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      border-radius: 999px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }

    .sr-only{
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="title">
        <h1>ASCII Punctuation Fixer</h1>
        <p class="subtitle">
          Converts "smart punctuation" and other Unicode troublemakers (curly quotes, em/en dashes, NBSP, ellipsis, zero-width chars, ligatures, etc.)
          into plain ASCII so code/configs/CSV/JSON don't get haunted.
        </p>
      </div>

      <div class="topbar">
        <div class="chip" role="group" aria-label="Options">
          <label title="Compatibility normalization (e.g., fullwidth forms).">
            <input type="checkbox" id="optNFKC" checked />
            NFKC normalize
          </label>
          <label title="Removes ZWSP/ZWNJ/ZWJ/word-joiner/BOM/soft hyphen.">
            <input type="checkbox" id="optInvisible" checked />
            Remove invisibles
          </label>
          <label title="Converts typographic ligatures like ﬁ → fi.">
            <input type="checkbox" id="optLigatures" checked />
            Fix ligatures
          </label>
          <label title="Convert while you type (may be slower for huge texts).">
            <input type="checkbox" id="optLive" checked />
            Live
          </label>
        </div>

        <div class="chip stats" aria-live="polite">
          <span class="dot" aria-hidden="true"></span>
          <span><span id="statRepl">0</span> replacements</span>
          <span class="dot" aria-hidden="true"></span>
          <span><span id="statSusp">0</span> suspicious chars</span>
        </div>
      </div>
    </header>

    <div class="actions">
      <div class="btnrow">
        <button class="primary" id="btnConvert" title="Convert input to ASCII-safe output">
          Convert <span class="k">Ctrl</span> <span class="k">Enter</span>
        </button>
        <button id="btnSwap" title="Swap input and output">Swap</button>
        <button id="btnCopy" title="Copy output to clipboard">Copy output</button>
        <button id="btnDownload" title="Download output as .txt">Download .txt</button>
      </div>

      <div class="btnrow">
        <button id="btnSample" title="Insert a sample that contains common problematic characters">Load sample</button>
        <button class="danger" id="btnClear" title="Clear everything">Clear</button>
      </div>
    </div>

    <div class="grid">
      <section class="card" aria-label="Input">
        <div class="cardhead">
          <strong>Input</strong>
          <span class="hint">Paste text here</span>
        </div>
        <textarea id="input" spellcheck="false" placeholder="Paste your text…"></textarea>
      </section>

      <section class="card" aria-label="Output">
        <div class="cardhead">
          <strong>Output (ASCII-safe)</strong>
          <span class="hint">Converted text</span>
        </div>
        <textarea id="output" spellcheck="false" placeholder="Converted result…"></textarea>
      </section>
    </div>

    <details open>
      <summary>Diagnostics (what was found)</summary>
      <div class="diag">
        <div class="muted" style="margin: 0 0 10px; font-size: 13px;">
          Shows suspicious characters (non-ASCII, invisible, or mapped). Use this to extend rules when you encounter new weirdness.
        </div>
        <div id="diagWrap"></div>
      </div>
    </details>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script>
(() => {
  "use strict";

  const $ = (id) => document.getElementById(id);

  // ---------- Replacement rules ----------
  // Goal: Convert common "smart punctuation" and friends into plain ASCII equivalents.
  // You can extend this map as you encounter new characters in diagnostics.
  const REPLACEMENTS = new Map([
    // Curly quotes / guillemets
    ["“", '"'], ["”", '"'], ["„", '"'], ["‟", '"'], ["«", '"'], ["»", '"'],
    ["‘", "'"], ["’", "'"], ["‚", "'"], ["‛", "'"],

    // Prime marks sometimes used as quotes
    ["′", "'"], ["″", '"'], ["‵", "'"], ["‶", '"'],

    // Accents/backticks commonly pasted as apostrophes
    ["´", "'"], ["`", "'"],

    // Dashes and minus variants
    ["‐", "-"], ["-", "-"], ["‒", "-"], ["–", "-"], ["—", "-"], ["―", "-"],
    ["−", "-"], // minus sign

    // Ellipsis
    ["…", "..."],

    // Spaces that break parsers
    ["\u00A0", " "], // NBSP
    ["\u202F", " "], // narrow NBSP
    ["\u2007", " "], // figure space
    ["\u2009", " "], // thin space
    ["\u200A", " "], // hair space
    ["\u3000", " "], // ideographic space

    // Bullets / middots (conservative)
    ["•", "-"], ["‣", "-"], ["∙", "*"], ["·", "."],

    // Arrows often seen in docs
    ["→", "->"], ["←", "<-"], ["⇒", "=>"], ["⇐", "<="],

    // Math-ish symbols that sneak in
    ["×", "x"], ["÷", "/"],

    // Fullwidth punctuation variants
    ["＿", "_"], ["／", "/"], ["＼", "\\"],
  ]);

  // Zero-width and invisible troublemakers (removed if enabled)
  const INVISIBLES_REGEX = /[\u200B\u200C\u200D\u2060\uFEFF\u00AD]/g; // ZWSP/ZWNJ/ZWJ/word-joiner/BOM/soft hyphen

  // Typographic ligatures (optional)
  const LIGATURES = new Map([
    ["ﬀ", "ff"], ["ﬁ", "fi"], ["ﬂ", "fl"], ["ﬃ", "ffi"], ["ﬄ", "ffl"], ["ﬅ", "ft"], ["ﬆ", "st"],
  ]);

  function normalizeNFKC(s) {
    try { return s.normalize("NFKC"); } catch { return s; }
  }

  // Convert text + return metadata for stats
  function convertText(input, opts) {
    let s = input;

    if (opts.nfkc) s = normalizeNFKC(s);
    if (opts.removeInvisible) s = s.replace(INVISIBLES_REGEX, "");

    let out = "";
    let replacements = 0;

    for (const ch of s) {
      if (opts.ligatures && LIGATURES.has(ch)) {
        out += LIGATURES.get(ch);
        replacements++;
        continue;
      }
      if (REPLACEMENTS.has(ch)) {
        out += REPLACEMENTS.get(ch);
        replacements++;
        continue;
      }
      out += ch;
    }

    // Optional mild cleanup: collapse repeated spaces/tabs but keep newlines intact.
    out = out.replace(/[ \t]{2,}/g, " ");

    return { out, replacements };
  }

  function classifyChar(ch, opts) {
    if (opts.removeInvisible && INVISIBLES_REGEX.test(ch)) {
      INVISIBLES_REGEX.lastIndex = 0;
      return { kind: "invisible", replacement: "(removed)" };
    }
    INVISIBLES_REGEX.lastIndex = 0;

    if (opts.ligatures && LIGATURES.has(ch)) return { kind: "ligature", replacement: JSON.stringify(LIGATURES.get(ch)) };
    if (REPLACEMENTS.has(ch)) return { kind: "mapped", replacement: JSON.stringify(REPLACEMENTS.get(ch)) };

    const cp = ch.codePointAt(0);
    if (cp > 0x7F) return { kind: "non-ascii", replacement: "(no rule)" };

    return null;
  }

  function escapeVisible(ch) {
    if (ch === "\n") return "\\n";
    if (ch === "\r") return "\\r";
    if (ch === "\t") return "\\t";
    if (ch === " ") return "␠";
    return ch;
  }

  function hexCodepoint(ch) {
    return "U+" + ch.codePointAt(0).toString(16).toUpperCase().padStart(4, "0");
  }

  function buildDiagnostics(input, opts) {
    const counts = new Map(); // char -> {count, kind, replacement}
    for (const ch of input) {
      const info = classifyChar(ch, opts);
      if (!info) continue;

      const prev = counts.get(ch);
      if (prev) prev.count++;
      else counts.set(ch, { count: 1, ...info });
    }

    const rows = [...counts.entries()]
      .map(([ch, meta]) => ({ ch, ...meta, cp: hexCodepoint(ch) }))
      .sort((a, b) => b.count - a.count);

    return rows;
  }

  function renderDiagnostics(rows) {
    const wrap = $("diagWrap");

    if (!rows.length) {
      wrap.innerHTML = `<div class="muted">No suspicious characters found.</div>`;
      return;
    }

    const body = rows.map(r => {
      const charShown = escapeVisible(r.ch);
      const charCell = `<span class="charbox" title="${r.cp}">${charShown}</span>`;
      const kind = `<span class="pill">${r.kind}</span>`;
      return `
        <tr>
          <td>${charCell}</td>
          <td class="mono">${r.cp}</td>
          <td>${kind}</td>
          <td class="mono">${r.count}</td>
          <td class="mono">${r.replacement}</td>
        </tr>
      `.trim();
    }).join("");

    wrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Char</th>
            <th>Codepoint</th>
            <th>Type</th>
            <th>Count</th>
            <th>Replacement</th>
          </tr>
        </thead>
        <tbody>${body}</tbody>
      </table>
    `;
  }

  function toast(msg) {
    const el = $("toast");
    el.textContent = msg;
    el.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(() => el.classList.remove("show"), 1100);
  }

  function getOpts() {
    return {
      nfkc: $("optNFKC").checked,
      removeInvisible: $("optInvisible").checked,
      ligatures: $("optLigatures").checked,
      live: $("optLive").checked,
    };
  }

  function runConversion() {
    const opts = getOpts();
    const input = $("input").value;

    const { out, replacements } = convertText(input, opts);
    $("output").value = out;

    const diagRows = buildDiagnostics(input, opts);
    renderDiagnostics(diagRows);

    $("statRepl").textContent = String(replacements);
    $("statSusp").textContent = String(diagRows.reduce((sum, r) => sum + r.count, 0));
  }

  // ---------- UI events ----------
  $("btnConvert").addEventListener("click", runConversion);

  $("btnSwap").addEventListener("click", () => {
    const a = $("input").value;
    $("input").value = $("output").value;
    $("output").value = a;
    runConversion();
    toast("Swapped.");
  });

  $("btnCopy").addEventListener("click", async () => {
    const text = $("output").value;
    if (!text) { toast("Nothing to copy."); return; }

    try {
      await navigator.clipboard.writeText(text);
      toast("Copied.");
    } catch {
      // Fallback for older browsers / restricted contexts
      $("output").focus();
      $("output").select();
      document.execCommand("copy");
      toast("Copied (fallback).");
    }
  });

  $("btnDownload").addEventListener("click", () => {
    const text = $("output").value;
    if (!text) { toast("Nothing to download."); return; }

    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ascii_safe_output.txt";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    toast("Downloaded.");
  });

  $("btnClear").addEventListener("click", () => {
    $("input").value = "";
    $("output").value = "";
    $("diagWrap").innerHTML = `<div class="muted">Paste text to see diagnostics.</div>`;
    $("statRepl").textContent = "0";
    $("statSusp").textContent = "0";
    toast("Cleared.");
  });

  $("btnSample").addEventListener("click", () => {
    $("input").value =
`Here’s a sample with “smart quotes”, ‘apostrophes’, and an em dash — plus an en dash –.
NBSP: between these two words: "Hello\u00A0World"
Ellipsis…  Arrows → ← ⇒ ⇐
Zero-width chars: [\u200BZWSP] [\u2060WJ] and a soft hyphen: co\u00ADoperate
Ligatures: ﬁ ﬂ ﬃ
Minus sign: 10 − 3 = 7`;
    runConversion();
    toast("Sample loaded.");
  });

  // Options
  for (const id of ["optNFKC", "optInvisible", "optLigatures"]) {
    $(id).addEventListener("change", runConversion);
  }

  // Live conversion (debounced)
  let debounce = null;
  $("input").addEventListener("input", () => {
    if (!getOpts().live) return;
    clearTimeout(debounce);
    debounce = setTimeout(runConversion, 120);
  });

  // Keyboard shortcut: Ctrl+Enter converts
  document.addEventListener("keydown", (e) => {
    const isMac = navigator.platform.toUpperCase().includes("MAC");
    const ctrlOrCmd = isMac ? e.metaKey : e.ctrlKey;
    if (ctrlOrCmd && e.key === "Enter") {
      e.preventDefault();
      runConversion();
      toast("Converted.");
    }
  });

  // Initial state
  $("diagWrap").innerHTML = `<div class="muted">Paste text to see diagnostics.</div>`;
})();
</script>
</body>
</html>
